<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="https://dable.io/wp-content/uploads/2021/03/favicon.ico">
  <title>Ads Sales Pipeline Manager v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="flex flex-col h-screen overflow-hidden">
  <!-- 1. MASTER HEADER -->
  <header class="bg-white border-b border-gray-200 px-6 h-16 flex justify-between items-center shadow-sm z-30 flex-none">
    <div class="flex items-center gap-3">
      <div class="bg-blue-600 p-1.5 rounded-lg text-white shadow-lg shadow-blue-500/30">
        <span class="material-symbols-outlined block text-[22px]">ads_click</span>
      </div>
      <div>
        <h1 class="text-lg font-bold text-gray-800 tracking-tight leading-none">Ads Sales Pipeline MGMT</h1>
        <span class="text-[10px] font-medium text-gray-400 tracking-wide uppercase">Partner Dashboard</span>
      </div>
    </div>
    
    <div class="flex items-center gap-2">
       <button onclick="toggleModal('newPipelineModal')" 
               class="h-9 px-4 bg-white border border-gray-200 hover:border-blue-400 hover:text-blue-600 text-gray-600 rounded-lg text-sm font-semibold shadow-sm transition-all flex items-center gap-2 group">
         <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-blue-500 transition-colors">add_circle</span> 신규 등록
       </button>
       <button onclick="toggleModal('recordActionModal')" 
               class="h-9 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold shadow-md shadow-blue-500/20 transition-all flex items-center gap-2">
         <span class="material-symbols-outlined text-[18px]">edit_note</span> 액션 기록
       </button>
    </div>
  </header>

  <!-- 2. FILTER & NAVIGATION BAR -->
  <div id="filter-nav-bar" class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between gap-4 shrink-0 z-20 min-h-[72px]">
    <div id="filter-container" class="flex items-center gap-2 w-full overflow-x-auto custom-scroll pb-1 md:pb-0">
      <div class="relative w-[300px] shrink-0 group" style="width: 300px; min-width: 300px; max-width: 300px;">
        <span class="material-symbols-outlined absolute left-3 text-gray-400 group-focus-within:text-blue-500 transition-colors" style="font-size: 15.3px; top: 50%; transform: translateY(-50%);">search</span>
        <input type="text" id="global-search" onkeyup="applyGlobalSearch()" placeholder="검색 (Client, Campaign)..." class="input-clean pr-9" style="padding-left: 2.5rem;">
        <button onclick="clearGlobalSearch()" class="absolute right-3 text-gray-400 hover:text-gray-600" style="top: 50%; transform: translateY(-50%);"><span class="material-symbols-outlined" style="font-size: 10.8px;">close</span></button>
      </div>
      <select id="global-filter-product" onchange="applyGlobalFilters()" class="input-clean w-32 shrink-0 cursor-pointer text-center text-center-last">
        <option value="">Product</option>
        <option value="DNA">DNA</option>
        <option value="RMP">RMP</option>
      </select>
      <select id="global-filter-owner" onchange="applyGlobalFilters()" class="input-clean w-32 shrink-0 cursor-pointer text-center text-center-last">
        <option value="">Owner</option>
      </select>
      <select id="global-filter-stage" onchange="applyGlobalFilters()" class="input-clean w-32 shrink-0 cursor-pointer text-center text-center-last">
        <option value="">Stage</option>
        <option value="contact">Contact</option>
        <option value="lead">Lead</option>
        <option value="propose">Propose</option>
        <option value="closed_won">Closed Won</option>
        <option value="closed_lost">Closed Lost</option>
      </select>
      <div id="cold-toggles" class="hidden flex items-center rounded-lg p-1 gap-4 shrink-0 ml-4 border-l border-gray-200 pl-6">
         <button onclick="toggleActionFilter('call', 'btn-h-call')" id="btn-h-call" class="btn-filter filter-call">CALL</button>
         <button onclick="toggleActionFilter('email', 'btn-h-mail')" id="btn-h-mail" class="btn-filter filter-mail">MAIL</button>
         <button onclick="toggleActionFilter('meeting', 'btn-h-meet')" id="btn-h-meet" class="btn-filter filter-meet">MEET</button>
      </div>
    </div>
    <div class="flex items-center gap-3 ml-auto shrink-0">
      <button onclick="switchSection('board')" id="nav-board" class="btn-toolbar w-28">
        <span class="material-symbols-outlined text-[20px]">bar_chart</span> Board
      </button>
      <div class="h-6 w-px bg-gray-200 hidden md:block"></div>
      <button onclick="switchSection('active')" id="nav-active" class="btn-toolbar w-28 active-active">
        <span class="material-symbols-outlined text-[20px]">view_kanban</span> Active
      </button>
      <div class="h-6 w-px bg-gray-200 hidden md:block"></div>
      <button onclick="switchSection('pipe')" id="nav-pipe" class="btn-toolbar w-28">
        <span class="material-symbols-outlined text-[20px]">contact_phone</span> PIPE
      </button>
    </div>
  </div>

  <!-- 3. CONTENT AREA -->
  <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50/50">
    
    <!-- DASHBOARD -->
    <section id="sec-board" class="hidden max-w-[1920px] mx-auto space-y-6">
      <!-- Row 1: Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
          <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Contacts</p>
          <h3 id="sum-contact" class="text-2xl font-bold text-gray-800 text-right font-mono">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
          <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Meetings</p>
          <h3 id="sum-meeting" class="text-2xl font-bold text-blue-600 text-right font-mono">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
          <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Negotiations</p>
          <h3 id="sum-nego" class="text-2xl font-bold text-yellow-600 text-right font-mono">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
          <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Closed Won</p>
          <h3 id="sum-won" class="text-2xl font-bold text-green-600 text-right font-mono">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
          <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Budget Sum</p>
          <h3 id="sum-budget" class="text-lg font-bold text-gray-800 text-right font-mono">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
          <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">Won Budget</p>
          <h3 id="sum-won-budget" class="text-lg font-bold text-green-600 text-right font-mono">0</h3>
        </div>
      </div>

      <!-- Row 2: Standard Charts -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
          <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-400"></span>Contact Trend</h4>
          <div class="flex-1"><canvas id="chart-contact"></canvas></div>
          <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs text-gray-400 font-medium">THIS MONTH</span>
            <p id="card-contact" class="text-xl font-bold text-gray-800">0</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
          <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span>Meeting Trend</h4>
          <div class="flex-1"><canvas id="chart-meeting"></canvas></div>
          <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs text-gray-400 font-medium">THIS MONTH</span>
            <p id="card-meeting" class="text-xl font-bold text-blue-600">0</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
          <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-500"></span>Negotiation Trend
            <div class="info-icon-wrapper">
              <span class="material-symbols-outlined info-icon">info</span>
              <div class="custom-tooltip">Lead + Nego</div>
            </div>
          </h4>
          <div class="flex-1"><canvas id="chart-nego"></canvas></div>
          <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs text-gray-400 font-medium">THIS MONTH</span>
            <p id="card-nego" class="text-xl font-bold text-yellow-600">0</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
          <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span>Closed Won Trend</h4>
          <div class="flex-1"><canvas id="chart-won"></canvas></div>
          <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs text-gray-400 font-medium">THIS MONTH</span>
            <p id="card-won" class="text-xl font-bold text-green-600">0</p>
          </div>
        </div>
      </div>

      <!-- Row 3: Advanced Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
          <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-indigo-500"></span>Meeting Conversion Rate
            <div class="info-icon-wrapper">
              <span class="material-symbols-outlined info-icon">info</span>
              <div class="custom-tooltip w-[240px]">Contacted Meeting / Total Sales Action</div>
            </div>
          </h4>
          <div class="flex-1"><canvas id="chart-rate-meeting"></canvas></div>
          <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs text-gray-400 font-medium">THIS MONTH</span>
            <p id="card-rate-meeting" class="text-xl font-bold text-indigo-600">0%</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
          <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-rose-500"></span>Booking Rate
            <div class="info-icon-wrapper">
              <span class="material-symbols-outlined info-icon">info</span>
              <div class="custom-tooltip w-[250px]">In 14d Lead + Negoed Won / Total Lead + Nego</div>
            </div>
          </h4>
          <div class="flex-1"><canvas id="chart-rate-booking"></canvas></div>
          <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs text-gray-400 font-medium">THIS MONTH</span>
            <p id="card-rate-booking" class="text-xl font-bold text-rose-600">0%</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col">
          <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>Won Budget Trend</h4>
          <div class="flex-1"><canvas id="chart-won-budget"></canvas></div>
          <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-xs text-gray-400 font-medium">THIS MONTH</span>
            <p id="card-won-budget" class="text-xl font-bold text-emerald-600">0</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIVE & PIPE -->
    <section id="sec-list-view" class="block max-w-[1920px] mx-auto h-full flex flex-col">
      <div class="table-container custom-scroll flex-1">
        <table>
          <thead>
            <tr>
              <!-- 헤더 수정: 텍스트와 아이콘을 header-content로 감싸서 배치 -->
              <th class="col-date" onclick="toggleSort('lastDate')">
                <div class="header-content">DATE <span id="sort-icon-lastDate" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-prod" onclick="toggleSort('product')">
                <div class="header-content">PRODUCT <span id="sort-icon-product" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-client" onclick="toggleSort('client')">
                <div class="header-content">CLIENT <span id="sort-icon-client" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-camp" onclick="toggleSort('campaign')">
                <div class="header-content">CAMPAIGN <span id="sort-icon-campaign" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-count" onclick="toggleSort('count')">
                <div class="header-content">CNT <span id="sort-icon-count" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-followup" onclick="toggleSort('followup')">
                <div class="header-content">F/up <span id="sort-icon-followup" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-owner" onclick="toggleSort('owner')">
                <div class="header-content">OWNER <span id="sort-icon-owner" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-action" onclick="toggleSort('lastActionType')">
                <div class="header-content">ACTION <span id="sort-icon-lastActionType" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-stage" onclick="toggleSort('currentStage')">
                <div class="header-content">STAGE <span id="sort-icon-currentStage" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-budget" onclick="toggleSort('currentBudget')">
                <div class="header-content">BUDGET <span id="sort-icon-currentBudget" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-memo" onclick="toggleSort('lastMemo')">
                <div class="header-content">MEMO <span id="sort-icon-lastMemo" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-contact" onclick="toggleSort('contactName')">
                <div class="header-content">NAME <span id="sort-icon-contactName" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-phone" onclick="toggleSort('contactPhone')">
                <div class="header-content">PHONE <span id="sort-icon-contactPhone" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
              <th class="col-email" onclick="toggleSort('contactemail')">
                <div class="header-content">E-MAIL <span id="sort-icon-contactemail" class="material-symbols-outlined sort-icon" style="display: none;"></span></div>
              </th>
            </tr>
          </thead>
          <tbody id="pipelineList"></tbody>
        </table>
      </div>
      <div id="pagination-controls" class="flex justify-center items-center gap-4 mt-4 flex-none py-2"></div>
    </section>

  </main>

  <!-- Modals (기존과 동일) -->
  <div id="newPipelineModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 modal-backdrop" onclick="toggleModal('newPipelineModal')"></div>
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-50 p-6 border border-gray-100">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
        <h3 class="text-xl font-bold text-gray-800">신규 파이프라인 등록</h3>
        <button onclick="toggleModal('newPipelineModal')" class="text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
      </div>
      <form id="newPipelineForm" onsubmit="handleNewPipeline(event)">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Product</label><select name="product" class="input-clean"><option value="DNA">DNA</option><option value="RMP">RMP</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Owner *</label><select name="owner" id="newPipelineOwner" required class="input-clean"></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Client *</label><input type="text" name="client" id="newPipelineClient" required class="input-clean" oninput="checkDuplicateClient(this.value)"><div id="clientWarning" class="hidden text-red-500 text-xs mt-1" style="word-wrap: break-word; max-width: 100%;"></div><div id="clientMergeInfo" class="hidden text-blue-500 text-xs mt-1" style="word-wrap: break-word; max-width: 100%;"></div><div id="clientDuplicateError" class="hidden text-red-500 text-xs mt-1" style="word-wrap: break-word; max-width: 100%;">기존에 등록 된 PIPELINE입니다</div></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Date</label><div class="relative"><input type="text" name="actionDate" id="newPipelineActionDate" class="input-clean cursor-pointer" readonly><span class="material-symbols-outlined absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" style="font-size: 18px;">calendar_today</span></div></div>
          <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Campaign</label><input type="text" name="campaign" id="newPipelineCampaign" class="input-clean" oninput="checkDuplicatePipeline()"></div>
        </div>
        <div class="bg-blue-50/50 p-4 rounded-xl mb-6 border border-blue-100">
          <h4 class="text-xs font-bold text-blue-600 mb-3 flex items-center gap-1"><span class="material-symbols-outlined text-[16px]">person</span> 담당자 정보</h4>
          <div class="grid grid-cols-3 gap-3">
            <input name="contactName" placeholder="이름" class="input-clean">
            <input name="contactPhone" placeholder="전화번호" class="input-clean">
            <input name="contactemail" placeholder="이메일" class="input-clean">
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Type</label><select name="actionType" class="input-clean"><option value="email" selected>E-Mail</option><option value="call">Call</option><option value="meeting">Meeting</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Stage</label><select name="stage" class="input-clean"><option value="contact">Contact</option><option value="lead">Lead</option><option value="propose">Propose</option><option value="closed_won">Closed Won</option><option value="closed_lost">Closed Lost</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Budget</label><input name="budget" class="input-clean" oninput="formatBudgetInput(this)"></div>
        </div>
        <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Memo</label><textarea name="memo" rows="2" class="input-clean h-20 py-2 resize-none"></textarea></div>
        <div class="flex justify-between items-center pt-4 border-t border-gray-100">
          <label class="flex items-center gap-2 cursor-pointer" style="height: 2.625rem; width: 180px;">
            <input type="checkbox" name="followup" id="newPipelineFollowup" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <span class="text-xs font-medium text-gray-700">FOLLOW UP 필요</span>
          </label>
          <div class="flex gap-2">
            <button type="button" onclick="toggleModal('newPipelineModal')" class="px-6 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition w-[120px]">취소</button>
            <button type="submit" id="newPipelineSubmitBtn" class="px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md shadow-blue-500/30 transition text-sm w-[120px]">등록하기</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div id="recordActionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 modal-backdrop" onclick="toggleModal('recordActionModal')"></div>
    <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl z-50 p-6 border border-gray-100">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
        <h3 class="text-xl font-bold text-gray-800">세일즈 액션 기록</h3>
        <button onclick="toggleModal('recordActionModal')" class="text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
      </div>
      <form id="recordActionForm" onsubmit="handleRecordAction(event)">
        <div class="mb-6 relative" id="record-dropdown-container">
          <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Select Pipeline *</label>
          <div class="input-clean cursor-pointer flex justify-between items-center" id="recordSearchInputWrapper" onclick="showRecordDropdown()" style="padding: 0.5rem 0.75rem;">
            <input type="text" id="recordSearchInput" placeholder="파이프라인 검색..." autocomplete="off" onfocus="showRecordDropdown()" onkeyup="filterRecordDropdown()" onclick="showRecordDropdown()" class="flex-1 border-0 outline-none bg-transparent cursor-pointer" style="padding: 0;">
            <span id="recordSearchOwner" class="text-xs text-gray-400 ml-2"></span>
          </div>
          <input type="hidden" name="selectedId" id="recordSelectedId">
          <ul id="recordOptionsList" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto custom-scroll"><li class="p-3 text-gray-400 text-xs text-center">Loading...</li></ul>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Type</label><select name="actionType" class="input-clean"><option value="email" selected>E-Mail</option><option value="call">Call</option><option value="meeting">Meeting</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">New Stage</label><select name="stage" class="input-clean"><option value="contact">Contact</option><option value="lead">Lead</option><option value="propose">Propose</option><option value="closed_won">Closed Won</option><option value="closed_lost">Closed Lost</option></select></div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-gray-700 text-sm font-bold mb-2">예산 (Budget)</label><input type="text" name="budget" placeholder="숫자만 입력" class="input-clean" oninput="formatBudgetInput(this)"></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Date</label><div class="relative"><input type="text" name="actionDate" id="recordActionDate" class="input-clean cursor-pointer" readonly><span class="material-symbols-outlined absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" style="font-size: 18px;">calendar_today</span></div></div>
        </div>
        <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Memo</label><textarea name="memo" rows="3" class="input-clean h-24 py-2 resize-none"></textarea></div>
        <div class="flex justify-between items-center pt-4 border-t border-gray-100">
          <label class="flex items-center gap-2 cursor-pointer" style="height: 2.625rem; width: 180px;">
            <input type="checkbox" name="followup" id="recordActionFollowup" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <span class="text-xs font-medium text-gray-700">FOLLOW UP 필요</span>
          </label>
          <div class="flex gap-2">
            <button type="button" onclick="toggleModal('recordActionModal')" class="px-6 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition w-[120px]">취소</button>
            <button type="submit" class="px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md shadow-blue-500/30 transition text-sm w-[120px]">저장하기</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 modal-backdrop" onclick="toggleModal('editModal')"></div>
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-50 p-6 border border-gray-100">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
        <h3 class="text-xl font-bold text-gray-800">파이프라인 정보 수정</h3>
        <button onclick="toggleModal('editModal')" class="text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
      </div>
      <form id="editForm" onsubmit="handleEditSubmit(event)">
        <input type="hidden" name="originalId" id="editOriginalId">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Product</label><select name="product" id="editProduct" class="input-clean"><option value="DNA">DNA</option><option value="RMP">RMP</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Owner *</label><input type="text" name="owner" id="editOwner" required class="input-clean"></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Client *</label><input type="text" name="client" id="editClient" required class="input-clean" oninput="checkEditDuplicatePipeline()"><div id="editClientMergeInfo" class="hidden text-blue-500 text-xs mt-1" style="word-wrap: break-word; max-width: 100%;">기존에 동일한 PIPELINE이 확인되어 최신 PIPELINE으로 병합됩니다</div></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Date</label><div class="relative"><input type="text" name="actionDate" id="editPipelineActionDate" class="input-clean cursor-not-allowed" readonly disabled style="background-color: #f1f5f9; color: #94a3b8;"><span class="material-symbols-outlined absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" style="font-size: 18px;">calendar_today</span></div></div>
          <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Campaign</label><input type="text" name="campaign" id="editCampaign" class="input-clean" oninput="checkEditDuplicatePipeline()"></div>
        </div>
        <div class="bg-blue-50/50 p-4 rounded-xl mb-6 border border-blue-100">
          <h4 class="text-xs font-bold text-blue-600 mb-3 flex items-center gap-1"><span class="material-symbols-outlined text-[16px]">person</span> 담당자 정보</h4>
          <div class="grid grid-cols-3 gap-3">
            <input name="contactName" id="editName" placeholder="이름" class="input-clean">
            <input name="contactPhone" id="editPhone" placeholder="전화번호" class="input-clean">
            <input name="contactemail" id="editemail" placeholder="이메일" class="input-clean">
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Type</label><select name="actionType" class="input-clean" disabled><option value="email" selected>E-Mail</option><option value="call">Call</option><option value="meeting">Meeting</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Stage</label><select name="stage" class="input-clean" disabled><option value="contact">Contact</option><option value="lead">Lead</option><option value="propose">Propose</option><option value="closed_won">Closed Won</option><option value="closed_lost">Closed Lost</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Budget</label><input name="budget" class="input-clean" disabled></div>
        </div>
        <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Memo</label><textarea name="memo" rows="2" class="input-clean h-20 py-2 resize-none" disabled></textarea></div>
        <div class="flex justify-between items-center pt-4 border-t border-gray-100">
          <label class="flex items-center gap-2" style="height: 2.625rem; width: 180px;">
            <input type="checkbox" name="followup" id="editPipelineFollowup" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" disabled>
            <span class="text-xs font-medium text-gray-700">FOLLOW UP 필요</span>
          </label>
          <div class="flex gap-2">
            <button type="button" onclick="toggleModal('editModal')" class="px-6 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition w-[120px]">취소</button>
            <button type="submit" id="editBtn" class="px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md shadow-blue-500/30 transition text-sm w-[120px]">수정 완료</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div id="memoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 modal-backdrop" onclick="closeMemoModal()"></div>
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl z-50 p-6 relative">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Memo Detail</h3>
      <div id="memoContent" class="text-gray-700 whitespace-pre-wrap bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm leading-relaxed max-h-96 overflow-y-auto custom-scroll"></div>
      <button onclick="closeMemoModal()" class="mt-4 w-full py-2.5 bg-gray-100 hover:bg-gray-200 rounded-xl text-gray-700 font-bold transition text-sm">닫기</button>
    </div>
  </div>
  <!-- Follow-up 모달 -->
  <div id="followupModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 modal-backdrop" onclick="closeFollowupModal()"></div>
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl z-50 p-6 relative">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Follow-up Action Logs</h3>
      <div id="followupContent" class="text-gray-700 bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm leading-relaxed max-h-96 overflow-y-auto custom-scroll"></div>
      <button onclick="closeFollowupModal()" class="mt-4 w-full py-2.5 bg-gray-100 hover:bg-gray-200 rounded-xl text-gray-700 font-bold transition text-sm">닫기</button>
    </div>
  </div>
  <!-- 액션 편집 모달 -->
  <div id="editActionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 modal-backdrop" onclick="toggleModal('editActionModal')"></div>
    <div class="bg-white w-full max-w-xl rounded-2xl shadow-2xl z-50 p-6 border border-gray-100">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
        <h3 class="text-xl font-bold text-gray-800">세일즈 액션 정보 수정</h3>
        <button onclick="toggleModal('editActionModal')" class="text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button>
      </div>
      <form id="editActionForm" onsubmit="handleEditActionSubmit(event)">
        <div class="mb-6 relative" id="edit-action-dropdown-container">
          <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Select Pipeline *</label>
          <div class="input-clean cursor-not-allowed flex justify-between items-center" id="editActionSearchInputWrapper" style="background-color: #f1f5f9; color: #94a3b8; padding: 0.5rem 0.75rem;">
            <input type="text" id="editActionSearchInput" placeholder="파이프라인 검색..." autocomplete="off" class="flex-1 border-0 outline-none bg-transparent cursor-not-allowed" disabled style="background-color: transparent; color: #94a3b8; padding: 0;">
            <span id="editActionSearchOwner" class="text-xs text-gray-400 ml-2"></span>
          </div>
          <input type="hidden" name="selectedId" id="editActionSelectedId">
          <input type="hidden" name="actionId" id="editActionActionId">
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Type</label><select name="actionType" id="editActionActionType" class="input-clean"><option value="email" selected>E-Mail</option><option value="call">Call</option><option value="meeting">Meeting</option></select></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">New Stage</label><select name="stage" id="editActionStage" class="input-clean"><option value="contact">Contact</option><option value="lead">Lead</option><option value="propose">Propose</option><option value="closed_won">Closed Won</option><option value="closed_lost">Closed Lost</option></select></div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-gray-700 text-sm font-bold mb-2">예산 (Budget)</label><input type="text" name="budget" id="editActionBudget" placeholder="숫자만 입력" class="input-clean" oninput="formatBudgetInput(this)"></div>
          <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Action Date</label><div class="relative"><input type="text" name="actionDate" id="editActionDate" class="input-clean cursor-pointer" readonly><span class="material-symbols-outlined absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none" style="font-size: 18px;">calendar_today</span></div></div>
        </div>
        <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Memo</label><textarea name="memo" id="editActionMemo" rows="3" class="input-clean h-24 py-2 resize-none"></textarea></div>
        <div class="flex justify-between items-center pt-4 border-t border-gray-100">
          <label class="flex items-center gap-2 cursor-pointer" style="height: 2.625rem; width: 180px;">
            <input type="checkbox" name="followup" id="editActionFollowup" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <span class="text-xs font-medium text-gray-700">FOLLOW UP 필요</span>
          </label>
          <div class="flex gap-2">
            <button type="button" onclick="toggleModal('editActionModal')" class="px-6 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition w-[120px]">취소</button>
            <button type="submit" class="px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md shadow-blue-500/30 transition text-sm w-[120px]">수정 완료</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- 날짜 선택 달력 팝업 -->
  <div id="datePickerModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-30" onclick="closeDatePicker()"></div>
    <div class="bg-white rounded-xl shadow-2xl p-4 z-[61] relative" style="min-width: 280px;">
      <div class="flex justify-between items-center mb-3">
        <button onclick="changeDatePickerMonth(-1)" class="p-1 hover:bg-gray-100 rounded"><span class="material-symbols-outlined text-gray-600">chevron_left</span></button>
        <h3 id="datePickerMonthYear" class="text-sm font-bold text-gray-800"></h3>
        <button onclick="changeDatePickerMonth(1)" class="p-1 hover:bg-gray-100 rounded"><span class="material-symbols-outlined text-gray-600">chevron_right</span></button>
      </div>
      <div id="datePickerCalendar" class="grid grid-cols-7 gap-1 mb-2">
        <!-- 달력 내용이 여기에 동적으로 생성됩니다 -->
      </div>
      <div class="flex justify-end gap-2 mt-3">
        <button onclick="closeDatePicker()" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded">취소</button>
        <button onclick="selectTodayDate()" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">오늘</button>
      </div>
    </div>
  </div>
  <section id="sec-migration" class="hidden"><div id="migResult"></div></section>
  <script src="supabaseClient.js"></script>
  <script src="script.js" defer></script>
</body>
</html>
